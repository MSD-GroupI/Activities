{% extends 'base.html' %}

{% block content %}


    <section class="home-section nopadd-bot color-dark text-center">

        <div class="container marginbot-50">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2">
                    <div class="animatedParent">
                        <div class="section-heading text-center">
                            <h2 class="h-bold animated bounceInDown">{{ activity_form.title }}</h2>
                            <div class="divider-header"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row marginbot-80">
                <div class="col-md-8 col-md-offset-2">
                    <form class="input-form" action="" method="POST">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-12">
                                {% if activity_form.message %}
                                    <p class="error-list">{{ activity_form.message }}</p>
                                {% endif %}
                                {% for field in activity_form %}
                                    <div class="form-group typeahead">
                                        {{ field }}
                                        {% if field.errors %}
                                            <li class="error-list">
                                                {% for error in field.errors %}
                                                    <ul>{{ error }}</ul>
                                                {% endfor %}
                                            </li>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <input type="submit" value="Create" class="btn btn-skin btn-lg btn-block"/>
                    </form>

                </div>
            </div>
        </div>

        <div class="container marginbot-50">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2">
                    <div class="animatedParent">
                        <div id="div_time_reccomendation" class="section-heading text-center">
                        </div>
                        <div id="div_activities_reccomendation" class="section-heading text-center">
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>

{% endblock %}

{% block scripts %}

<script type="text/javascript">
    function minutesToTimeString(minutes){
        return (minutes/60).toFixed(0) + ":" + (minutes%60).toFixed(0);
    };

    function getTimeReccomendation(fromTime,toTime){
        return "<h5>Time recommendations</h5><p>This type of activity usually takes place between " + fromTime +  " and " + toTime + "</p>"
    };

    function extractDate(value){
        return value.split("T")[0];
    }

    function extractTime(value){
        return value.split("T")[1].split(".")[0];
    }

    function getActivitiesReccomendation(activities){
        var result = "<h5>Similar activities</h5>";
        activities.forEach(function(item,i,activities){
            result += "<div class=\"row\">";
            result += "<p>" + item[1]  + " - " + extractDate(item[2]) + " - "  + extractTime(item[2]) + "</p>";
            result +=           '<button type="button" class="btn btn-skin"' +
                                'onclick="$.ajax(/activity/join?user_id={{ user.id }}&activity_id=' + item[0] + ')' +
                                '.done(function() { location.reload() })">' +
                                'Join' +
                                '</button>';
            result += "</div>";
        });
        return result;
    };

    function recommendationsRequest(){

        var type = $('#create_form_activity_type').val();

        if(type == ''){
            setTimeout(recommendationsRequest, 5000);
            return;
        }

        $.ajax({
            url: "{% url 'activity:recommendations' %}" + '?' + 'type=' + type,
            type: "GET",
            dataType: "json",
            contentType : "application/json",
            async: false,
            success : recommendationsResponse, 
            error : console.log,
        })
        .always(function() {setTimeout(recommendationsRequest, 5000);});
    };

    function recommendationsResponse(response){
        var timeRecEl = document.getElementById("div_time_reccomendation");
        var actRecEl = document.getElementById("div_activities_reccomendation");

        if(response.times == ""){
            timeRecEl.innerHTML = ""    
        }
        else{
            var times = response.times.split("_");
            var fromTime = parseFloat(minutesToTimeString(times[0]));
            var toTime = parseFloat(minutesToTimeString(times[1]));
            timeRecEl.innerHTML = getTimeReccomendation(fromTime,toTime);
        }

        if(response.activities == ""){
            actRecEl.innerHTML = "";
        }
        else{
            actRecEl.innerHTML = getActivitiesReccomendation(response.activities);
        }

    };
</script>

<script type="text/javascript">
    (function(){
        recommendationsRequest();
    })();
</script>

{% endblock %}
